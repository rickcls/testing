<?xml version="1.0" encoding="utf-8" ?>
<j:jelly trim="false" xmlns:j="jelly:core" xmlns:g="glide" xmlns:j2="null" xmlns:g2="null">
    <style>
        .container {
            display: flex;
            flex-direction: row;
            justify-content: flex-end;
            gap: 5px;
            margin-inline-start: 50px;
        }

        . .pir_heading {
            padding: 0px;
            margin: 0px;
            margin-block-start: 0px;
            margin-block-end: 0px;
            font-family: Lato;
            font-size: 42px;
            font-weight: 700;
            line-height: 40px;
            letter-spacing: 0em;
            text-align: left;
            color: #003F6A;
        }

        .related_record_header {
            font-family: Lato;
            font-size: 12px;
            font-weight: 400;
            line-height: 14px;
            letter-spacing: 0px;
            text-align: left;
            color: #454D5B;
        }

        .h1 {
            padding: 0px;
            margin-block-start: 0px;
            margin-block-end: 0px;
            color: #003F6A;
        }

        .h3 {
            padding: 0px;
            padding-bottom: 16px;
            margin-block-start: 0px;
            margin-block-end: 0px;

            font-size: 20px;
            font-weight: 700;
            line-height: 24px;
            letter-spacing: 0em;
            text-align: left;
        }

        .header_row {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
        }

        .header_column {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .column1 {
            min-width: 135px;
            margin-top: 2px;
            display: grid;
            justify-content: flex-end;
        }

        .column2 {
            margin-top: 5px;
            width: 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .column3 {
            display: flex;
            flex-direction: column;
            flex: 1;
            justify-content: flex-start;
            word-wrap: break-word;
            width: 50ch;
        }

        .button {
            max-width: fit-content;
            display: inline-block;
            padding: 8px;
            border-radius: 4px;
            margin: -2px 3px 10px 3px;
            color: rgb(21, 25, 32);
        }

        .button_1 {
            border-color: #EDEEF8;
            background-color: #EDEEF8;
        }

        .button_2 {
            border-color: #F8C8CD;
            background-color: #F8C8CD;
        }

        .button_3 {
            color: rgb(21, 25, 32);
            border-color: #D4EED8;
            background-color: #D4EED8;
        }

        .hr {
            border: 1px solid #ccc;
            /* Change color as needed */
        }

        .image {
            width: 16px
        }

        .timezone_image {
            width: 30px;
        }

        @media print {
            img {
                visibility: visible;
                display: inline-block;
            }
        }

        .flex-container {
            padding: 16px;
            box-sizing: border-box;
        }

        .outer_container {
            padding: 24px;
        }

        .new-line {
            color: #D3D6DC;
            background: #D3D6DC;
        }

        .incident-values {
            padding-right: 32px;
        }

        .incident-values-text {
            color: #454D5B;
            font-size: 16px;
        }

        .flex-row {
            display: flex;
            flex-direction: row;
        }

        .gap-high {
            gap: 16px;
        }

        .padding-high {
            padding-bottom: 24px;
        }

        .padding-low {
            padding-top: 8px;
        }

        .gap-low {
            gap: 8px;
        }

        .incident-details {
            padding-right: 24px;
            gap: 4px;
        }

        .contributor-details {
            width: 50%;
            word-break: break-word;
        }

        .response-timing-header-first-container {
            border: 1px solid #ccc;
            border-radius: 5px;
            width: fit-content;
        }

        .margin-right-low {
            margin-right: 8px
        }

        .margin-right-high {
            margin-right: 16px
        }

        .response-timing-header-second-container {
            border: 1px solid #ccc;
            border-radius: 5px;
            width: auto;
        }

        .separator-dot {
            color: #CECFED;
            margin-top: 1px;
            margin-bottom: 1px;
        }

        .total-related-records {
            margin-left: 4px;
            margin-top: 0px;
            background: #A8A8B0;
            padding: 4px;
            border-radius: 2px
        }

        .align-items-center {
            align-items: center;
        }

        .related-record-color {
            color: #454D5B;
        }

        .margin-top {
            margin-top: 24px;
        }

        .black {
            text-align: right;
            max-width: 80px;
            color: black;
        }

        .font-size-low {
            font-size: 16px;
        }

        .font-size-high {
            font-size: 20px;
        }

        .wrap-text {
            white-space: pre-line;
        }

        .related-records .related-record {
            padding-bottom: 20pxe;
        }

        .related-records .related-record table {
            padding: 2px;
            width: 100%;
            border: 1px solid #E6E8EA;
        }

        .related-records .related-record table th {
            text-align: left;
            width: 33%
        }

        .related-records .related-record table {
            border-collapse: collapse;
        }

        .related-records .related-record tr {
            border: none;
        }

        .related-records .related-record td,
        .related-records .related-record th {
            border-right: solid 1px #E6E8EA;
            border-left: solid 1px #E6E8EA;
            padding-left: 13px;
            padding-right: 13px;
            padding-top: 6px;
            padding-bottom: 6px;
            width: 33%
        }

        .related-records .related-record td:first-child,
        .related-records .related-record th:first-child {
            border-left: none;
        }

        .related-records .related-record td:last-child,
        .related-records .related-record th:last-child {
            border-right: none;
        }

        html.rtl .related-records .related-record table th {
            text-align: right;
        }

        html.rtl .related-records .related-record .header .table-title {
            margin-right: 15px;
        }
    </style>
    <g:evaluate var="jvar_pirEvents" jelly="true" object="true">
        var incidentSysId = RP.getParameterValue('sysparm_sys_id');
        var pirData = new PIRManager().fetchPreviewPageData(incidentSysId);
        var jvar_pirEvents = pirData.events;
        jvar_pirEvents
    </g:evaluate>
    <g:evaluate var="incidentRelatedData" jelly="true" object="true">
        var incidentSysId = RP.getParameterValue('sysparm_sys_id');
        var incidentRelatedData = new PIRManager().fetchIncidentRelatedData(incidentSysId);
        incidentRelatedData
    </g:evaluate>
    <g:evaluate var="pirIncidentRecord" jelly="true" object="true">
        var gr = new GlideRecordSecure('sn_sow_inc_post_incident_review');
        var pirIncidentRecord=null;
        gr.addQuery('incident_ref.sys_id', RP.getParameterValue('sysparm_sys_id'));
        gr.query();
        if (gr.next()) {
        pirIncidentRecord = gr;
        }
        pirIncidentRecord
    </g:evaluate>
    <g:evaluate var="showTimeline" jelly="true" object="true">
        var pirIncidentRecord = jelly.pirIncidentRecord;
        var showTimeline = false;
        if (pirIncidentRecord) {
        var timelineSettings = JSON.parse(pirIncidentRecord.getValue('timeline_settings'));
        showTimeline = timelineSettings.showTimelineInFinalReport;
        }
        showTimeline
    </g:evaluate>
    <g:evaluate var="jvar_incidentgr" jelly="true" object="true">
        var incidentGr = new GlideRecord('incident');
        incidentGr.get(RP.getParameterValue('sysparm_sys_id'));
        incidentGr;
    </g:evaluate>
    <g:evaluate var="arrayLength" jelly="true" object="true">
        var arrayLength = jelly.jvar_pirEvents.length;
        arrayLength
    </g:evaluate>
    <g:evaluate var="incidentRelatedDataLength" jelly="true" object="true">
        var incidentRelatedDataLength = jelly.incidentRelatedData.relatedRecords.length;
        incidentRelatedDataLength
    </g:evaluate>
    <g:evaluate var="counter" jelly="true" object="true">
        var counter = 0;
        counter
    </g:evaluate>
    <g:evaluate var="coAuthorsCounter" jelly="true" object="true">
        var coAuthorsCounter = 0;
        coAuthorsCounter
    </g:evaluate>
    <g:evaluate var="jvar_iframeUrl" jelly="true" object="true">
        var iframeUrl = "/sn_sow_inc_post_incident_report.do" + '?sysparm_sys_id=' + RP.getParameterValue('sysparm_sys_id');
        iframeUrl;
    </g:evaluate>
    <g:evaluate var="timezone" jelly="true" object="true">
        var targetTimezone = gs.getSession().getTimeZoneName();
        targetTimezone;
    </g:evaluate>
    <input type="hidden" id="url" name='url' value="${jvar_iframeUrl}" />
    <div class="outer_container">
        <div class="header_column">
            <div class="header_row">
                <h1 class="h1">${gs.getMessage("Post Incident Report")}</h1>
                <j:if test="${incidentRelatedData.access_permission.canPreviewAndDownloadPIR == true}">
                    <div>
                        <button onclick="exportPDF();" class="btn btn-primary download-report">${gs.getMessage("Download")}</button>
                    </div>
                </j:if>
            </div>
            <div class="gap-high">
                <span class="margin-right-low">
                    ${gs.getMessage("PIR Status:")}
                </span>
                <span class="margin-right-high">
                    ${pirIncidentRecord.getDisplayValue('state')}
                </span>
                <span class="margin-right-high">
                    |
                </span>
                <span class="margin-right-low">
                    ${gs.getMessage("Timezone:")}
                </span>
                <span>
                    ${gs.getMessage("All times in")} ${targetTimezone}
                </span>
            </div>
        </div>
        <hr class="new-line" />
        <div>
            <h3 class="h3">${incidentGr.getDisplayValue('short_description')}</h3>
            <div class="flex-row">
                <div class="incident-values">
                    <span class="incident-values-text">${gs.getMessage("Incident ID")}</span>
                    <p>${incidentGr.getDisplayValue('number')}</p>
                </div>
                <div class="incident-values">
                    <span class="incident-values-text">${gs.getMessage("Priority")}</span>
                    <p>${incidentGr.getDisplayValue('priority')}</p>
                </div>
                <div class="incident-values">
                    <span class="incident-values-text">${gs.getMessage("Opened")}</span>
                    <p>${incidentGr.getDisplayValue('opened_at')}</p>
                </div>
                <div class="incident-values">
                    <span class="incident-values-text">${gs.getMessage("Resolved")}</span>
                    <p>${incidentGr.getDisplayValue('resolved_at')}</p>
                </div>
            </div>
        </div>
        <div class="padding-high" />
        <div class="flex-row gap-high padding-high">
            <div class="flex-container response-timing-header-first-container">
                <span class="font-size-high">${gs.getMessage("Incident response timings")}</span>
                <div class="flex-row padding-low">
                    <div class="incident-details">
                        <span class="incident-values-text">${gs.getMessage("Time to Identify")}</span>
                        <p>${incidentRelatedData.incidentTimings[0]}</p>
                    </div>

                    <div class="incident-details">
                        <span class="incident-values-text">${gs.getMessage("Time to respond")}</span>
                        <p>${incidentRelatedData.incidentTimings[1]}</p>
                    </div>

                    <div class="incident-details">
                        <span class="incident-values-text">${gs.getMessage("Time to resolve")}</span>
                        <p>${incidentRelatedData.incidentTimings[2]}</p>
                    </div>
                </div>
            </div>

            <div class="flex-container response-timing-header-second-container">
                <span class="font-size-high">${gs.getMessage("Contributors")}</span>
                <div class="flex-row padding-low gap-low">
                    <div class="contributor-details">
                        <span class="incident-values-text">${gs.getMessage("Assigned to")}</span>
                        <p>${incidentRelatedData.assignedTo.name}</p>
                    </div>

                    <div class="contributor-details">
                        <span class="incident-values-text">${gs.getMessage("Responder")}</span>
                        <p>
                            <j:forEach items="${incidentRelatedData.coAuthors}" var="varAuthor">
                                <g:evaluate var="coAuthorsCounter" jelly="true" object="true">
                                    var coAuthorsCounter = ${coAuthorsCounter + 1};
                                    coAuthorsCounter;
                                </g:evaluate>
                                <g:evaluate var="author" jelly="true" object="true">
                                    var author = jelly.varAuthor;
                                    author
                                </g:evaluate>
                                ${author.user}
                                <j:if test="${coAuthorsCounter != incidentRelatedData.coAuthors.length}">
                                    ,
                                </j:if>
                            </j:forEach>
                        </p>
                    </div>
                </div>
            </div>
        </div>
        <hr class="new-line" />
        <div class="padding-high" />
        <h3 class="h3">${gs.getMessage("Incident summary")}</h3>
        <div>
            <g:evaluate var="htmlField" jelly="true" object="true">
                var htmlField = incidentRelatedData.summary;
                htmlField
            </g:evaluate>
            <g:no_escape>${HTML:htmlField}</g:no_escape>
        </div>
        <div class="padding-high" />
        <j:if test="${showTimeline == true}">
            <j:if test="${arrayLength != 0}">
                <hr class="new-line" />
                <div class="padding-high" />
                <h3 class="h3">${gs.getMessage("Timeline")}</h3>
                ${gs.getMessage("Event timeline below shows all the important events that took place during the incident lifecycle")}
                <div class="margin-top padding-high">
                    <j:forEach items="${jvar_pirEvents}" var="jvar_get">
                        <g:evaluate var="counter" jelly="true" object="true">
                            var counter = ${counter + 1};
                            counter;
                        </g:evaluate>

                        <div class="container">
                            <div class="column1">
                                <span class="black">${jvar_get.formattedDateTime}</span>
                            </div>
                            <div class="column2">
                                <j:choose>
                                    <j:when test="${jvar_get.eventType == 'INCIDENT_CREATED'}">
                                        <img class="image" src="sn_sow_inc.ellipse_1.png" />
                                    </j:when>

                                    <j:when test="${jvar_get.eventType == 'CUSTOM_EVENT'}">
                                        <img class="image" src="sn_sow_inc.comment.png" />
                                    </j:when>

                                    <j:when test="${jvar_get.eventType == 'ACTIVITY_FLAGGED'}">
                                        <img class="image" src="sn_sow_inc.flag.png" />
                                    </j:when>

                                    <j:when test="${jvar_get.eventType == 'INCIDENT_ACCEPTED_AS_MAJOR_INCIDENT'}">
                                        <img class="image" src="sn_sow_inc.fire.png" />
                                    </j:when>

                                    <j:when test="${jvar_get.eventType == 'INCIDENT_RESOLVED'}">
                                        <img class="image" src="sn_sow_inc.accepted.png" />
                                    </j:when>

                                    <j:otherwise>
                                        <img class="image" src="sn_sow_inc.ellipse_2.png" />
                                    </j:otherwise>
                                </j:choose>
                                <j:if test="${counter != arrayLength}">
                                    <j:forEach var="varProximityEvent" items="${jvar_get.events}">
                                        <span class="separator-dot">•</span>
                                        <span class="separator-dot">•</span>
                                    </j:forEach>
                                </j:if>
                            </div>
                            <div class="column3">
                                <j:forEach var="varProximityEvent" items="${jvar_get.events}">
                                    <g:evaluate var="proximityEvent" jelly="true" object="true">
                                        var proximityEvent = jelly.varProximityEvent;
                                        proximityEvent
                                    </g:evaluate>
                                    <j:if test="${proximityEvent.eventType != 'INCIDENT_RESOLVED'}">
                                        <j:if test="${proximityEvent.eventType != 'INCIDENT_ACCEPTED_AS_MAJOR_INCIDENT'}">
                                            <div>
                                                <span class="button button_1">${proximityEvent.message}</span>
                                            </div>
                                        </j:if>
                                    </j:if>
                                    <j:if test="${proximityEvent.eventType == 'INCIDENT_RESOLVED'}">
                                        <div>
                                            <span class="button button_3">${proximityEvent.message}</span>
                                        </div>
                                    </j:if>
                                    <j:if test="${proximityEvent.eventType == 'INCIDENT_ACCEPTED_AS_MAJOR_INCIDENT'}">
                                        <div>
                                            <span class="button button_2">${proximityEvent.message}</span>
                                        </div>
                                    </j:if>
                                </j:forEach>
                            </div>
                        </div>
                    </j:forEach>
                </div>
            </j:if>
        </j:if>
        <hr class="new-line" />
        <div class="padding-high" />
        <div class="related-records-wrapper">
            <div class="header">
                <h3 class="h3">${gs.getMessage("Related Records")}</h3>
            </div>
            <div class="content">
                <div class="related-records">
                    <div class="related-record">
                        <h4>${incidentGr.getElement('problem_id').getLabel()}</h4>
                        <g:evaluate jelly="true">
                            var prbGr = new GlideRecord('problem');
                            if (prbGr.get(incidentGr.problem_id + ''))
                            prbGr;
                        </g:evaluate>
                        <table>
                            <tr>
                                <th><b>${prbGr.getElement('number').getLabel()}</b></th>
                                <th><b>${prbGr.getElement('short_description').getLabel()}</b></th>
                                <th><b>${prbGr.getElement('assigned_to').getLabel()}</b></th>
                            </tr>
                            <tr>
                                <j:if test="${jvar_escape_text == true}">
                                    <td>${prbGr.getDisplayValue('number')}</td>
                                    <td>${prbGr.getDisplayValue('short_description')}</td>
                                    <td>${prbGr.getDisplayValue('assigned_to')}</td>
                                </j:if>
                                <j:if test="${jvar_escape_text != true}">
                                    <td>${html: prbGr.getDisplayValue('number')}</td>
                                    <td>${html: prbGr.getDisplayValue('short_description')}</td>
                                    <td>${html: prbGr.getDisplayValue('assigned_to')}</td>
                                </j:if>
                            </tr>
                        </table>
                    </div>
                    <div class="related-record">
                        <h4>${incidentGr.getElement('rfc').getLabel()}</h4>
                        <g:evaluate jelly="true">
                            var chgGr = new GlideRecord('change_request');
                            if (chgGr.get(incidentGr.rfc + ''))
                            chgGr;
                        </g:evaluate>
                        <table>
                            <tr>
                                <th><b>${chgGr.getElement('number').getLabel()}</b></th>
                                <th><b>${chgGr.getElement('short_description').getLabel()}</b></th>
                                <th><b>${chgGr.getElement('assigned_to').getLabel()}</b></th>
                            </tr>
                            <tr>
                                <j:if test="${jvar_escape_text == true}">
                                    <td>${chgGr.getDisplayValue('number')}</td>
                                    <td>${chgGr.getDisplayValue('short_description')}</td>
                                    <td>${chgGr.getDisplayValue('assigned_to')}</td>
                                </j:if>
                                <j:if test="${jvar_escape_text != true}">
                                    <td>${html: chgGr.getDisplayValue('number')}</td>
                                    <td>${html: chgGr.getDisplayValue('short_description')}</td>
                                    <td>${html: chgGr.getDisplayValue('assigned_to')}</td>
                                </j:if>
                            </tr>
                        </table>
                    </div>
                    <div class="related-record">
                        <h4>${incidentGr.getElement('caused_by').getLabel()}</h4>
                        <g:evaluate jelly="true">
                            var chgGr1 = new GlideRecord('change_request');
                            if (chgGr1.get(incidentGr.caused_by + ''))
                            chgGr1;
                        </g:evaluate>
                        <table>
                            <tr>
                                <th><b>${chgGr1.getElement('number').getLabel()}</b></th>
                                <th><b>${chgGr1.getElement('short_description').getLabel()}</b></th>
                                <th><b>${chgGr1.getElement('assigned_to').getLabel()}</b></th>
                            </tr>
                            <tr>
                                <j:if test="${jvar_escape_text == true}">
                                    <td>${chgGr1.getDisplayValue('number')}</td>
                                    <td>${chgGr1.getDisplayValue('short_description')}</td>
                                    <td>${chgGr1.getDisplayValue('assigned_to')}</td>
                                </j:if>
                                <j:if test="${jvar_escape_text != true}">
                                    <td>${html: chgGr1.getDisplayValue('number')}</td>
                                    <td>${html: chgGr1.getDisplayValue('short_description')}</td>
                                    <td>${html: chgGr1.getDisplayValue('assigned_to')}</td>
                                </j:if>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

</j:jelly>
